# ROS 2 Humble (Ubuntu 22.04) with ARM64 support
FROM ros:humble-desktop

ENV DEBIAN_FRONTEND=noninteractive
SHELL ["/bin/bash", "-c"]

# Basic deps, Gazebo bridge, tools
RUN apt-get update && apt-get install -y \
    ros-humble-ros-gz \
    ros-humble-rmw-fastrtps-cpp \
    ros-humble-vision-msgs \
    ros-humble-image-transport \
    python3-pip python3-colcon-common-extensions \
    git wget curl nano sudo locales ca-certificates \
    # Xfce + VNC + noVNC stack
    xfce4 xfce4-terminal tigervnc-standalone-server \
    supervisor x11-xserver-utils \
    # websockify (noVNC)
    novnc websockify \
    # utilities
    dbus-x11 policykit-1 net-tools \
    && rm -rf /var/lib/apt/lists/*

# Python packages for analysis
RUN pip install --no-cache-dir numpy pandas matplotlib jupyter

# Locale
RUN locale-gen en_US.UTF-8
ENV LANG=en_US.UTF-8 LC_ALL=en_US.UTF-8

# Create a user (optional; root is fine for dev)
RUN useradd -ms /bin/bash dev && echo "dev ALL=(ALL) NOPASSWD:ALL" >/etc/sudoers.d/dev
USER dev
WORKDIR /home/dev

# ROS setup in bashrc
RUN echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc

# Workspace
RUN mkdir -p /home/dev/datatrain_ws/src
WORKDIR /home/dev/datatrain_ws

# Add startup scripts and supervisor config
USER root
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf
COPY startup.d /opt/startup.d
RUN chmod +x /opt/startup.d/*.sh

# noVNC location varies; create a simple launcher symlink
RUN ln -s /usr/share/novnc /opt/novnc && ln -s /usr/share/novnc/utils/websockify /opt/novnc/utils/websockify

# Default env
ENV DISPLAY=:1 \
    VNC_PORT=5901 \
    NOVNC_PORT=6080 \
    VNC_RESOLUTION=1680x1050 \
    VNC_COL_DEPTH=24 \
    VNC_PASSWORD=datatrain \
    RMW_IMPLEMENTATION=rmw_fastrtps_cpp

# Build stage ends here; at runtime supervisor starts VNC + noVNC + XFCE
EXPOSE 5901 6080

# Switch back to dev user by default
USER dev
CMD ["/usr/bin/supervisord", "-n"]